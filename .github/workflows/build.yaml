name: build

on:
  push:
    tags:
      - 'v*'

jobs:
  build-ime:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Extract version from tag
      id: version
      shell: bash
      run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

    - name: Build x64 DLL
      shell: pwsh
      run: |
        cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -DVERSION_OVERRIDE=${{ steps.version.outputs.version }}
        cmake --build build --config Release

    - name: Build x86 DLL
      shell: pwsh
      run: |
        cmake -S . -B build32 -G "Visual Studio 17 2022" -A Win32 -DVERSION_OVERRIDE=${{ steps.version.outputs.version }}
        cmake --build build32 --config Release

    - name: Build installer with Inno Setup
      shell: pwsh
      run: |
        iscc /DAppVer=${{ steps.version.outputs.version }} installer/kolemak.iss

    - name: Upload IME artifact
      uses: actions/upload-artifact@v4
      with:
        name: ime-installer
        path: dist/kolemak-install.exe

  build-ahk:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install AutoHotkey v2 and Ahk2Exe
      shell: pwsh
      run: |
        $ahkRelease = Invoke-RestMethod "https://api.github.com/repos/AutoHotkey/AutoHotkey/releases/latest" -Headers @{ Authorization = "Bearer ${{ secrets.GITHUB_TOKEN }}" }
        $ahkZip = $ahkRelease.assets | Where-Object { $_.name -like '*.zip' } | Select-Object -First 1
        Invoke-WebRequest -Uri $ahkZip.browser_download_url -OutFile "$env:TEMP\ahk-v2.zip"
        Expand-Archive -Path "$env:TEMP\ahk-v2.zip" -DestinationPath "$env:TEMP\ahk-v2" -Force

        $compilerRelease = Invoke-RestMethod "https://api.github.com/repos/AutoHotkey/Ahk2Exe/releases/latest" -Headers @{ Authorization = "Bearer ${{ secrets.GITHUB_TOKEN }}" }
        $compilerZip = $compilerRelease.assets | Where-Object { $_.name -like '*.zip' } | Select-Object -First 1
        Invoke-WebRequest -Uri $compilerZip.browser_download_url -OutFile "$env:TEMP\ahk2exe.zip"
        Expand-Archive -Path "$env:TEMP\ahk2exe.zip" -DestinationPath "$env:TEMP\ahk-v2\Compiler" -Force

    - name: Prepare output dir
      shell: pwsh
      run: New-Item -ItemType Directory -Force -Path dist | Out-Null

    - name: Compile kolemak.ahk
      shell: pwsh
      run: |
        Start-Process -FilePath "$env:TEMP\ahk-v2\Compiler\Ahk2Exe.exe" -ArgumentList "/in","portable\kolemak.ahk","/out","dist\kolemak-portable.exe","/icon","assets\portable-icon.ico","/base","$env:TEMP\ahk-v2\AutoHotkey64.exe" -Wait -NoNewWindow
        if (!(Test-Path dist\kolemak-portable.exe)) { throw "Compilation failed for kolemak.ahk" }

    - name: Upload AHK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ahk-exe
        path: dist/*.exe

  release:
    needs: [build-ime, build-ahk]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download IME artifact
      uses: actions/download-artifact@v4
      with:
        name: ime-installer
        path: dist

    - name: Download AHK artifact
      uses: actions/download-artifact@v4
      with:
        name: ahk-exe
        path: dist

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        files: |
          dist/kolemak-install.exe
          dist/kolemak-portable.exe
