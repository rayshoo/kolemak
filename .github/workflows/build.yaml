name: build-ahk

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install AutoHotkey v2 and Ahk2Exe
      shell: pwsh
      run: |
        $ahkRelease = Invoke-RestMethod "https://api.github.com/repos/AutoHotkey/AutoHotkey/releases/latest" -Headers @{ Authorization = "Bearer ${{ secrets.GITHUB_TOKEN }}" }
        $ahkZip = $ahkRelease.assets | Where-Object { $_.name -like '*.zip' } | Select-Object -First 1
        Invoke-WebRequest -Uri $ahkZip.browser_download_url -OutFile "$env:TEMP\ahk-v2.zip"
        Expand-Archive -Path "$env:TEMP\ahk-v2.zip" -DestinationPath "$env:TEMP\ahk-v2" -Force

        $compilerRelease = Invoke-RestMethod "https://api.github.com/repos/AutoHotkey/Ahk2Exe/releases/latest" -Headers @{ Authorization = "Bearer ${{ secrets.GITHUB_TOKEN }}" }
        $compilerZip = $compilerRelease.assets | Where-Object { $_.name -like '*.zip' } | Select-Object -First 1
        Invoke-WebRequest -Uri $compilerZip.browser_download_url -OutFile "$env:TEMP\ahk2exe.zip"
        Expand-Archive -Path "$env:TEMP\ahk2exe.zip" -DestinationPath "$env:TEMP\ahk-v2\Compiler" -Force

    - name: Prepare output dir
      shell: pwsh
      run: New-Item -ItemType Directory -Force -Path dist | Out-Null

    - name: Compile changed.ahk
      shell: pwsh
      run: |
        Start-Process -FilePath "$env:TEMP\ahk-v2\Compiler\Ahk2Exe.exe" -ArgumentList "/in","portable\changed.ahk","/out","dist\kolemak-changed.exe","/icon","assets\icon.ico","/base","$env:TEMP\ahk-v2\AutoHotkey64.exe" -Wait -NoNewWindow
        if (!(Test-Path dist\kolemak-changed.exe)) { throw "Compilation failed for changed.ahk" }

    - name: Compile unchanged.ahk
      shell: pwsh
      run: |
        Start-Process -FilePath "$env:TEMP\ahk-v2\Compiler\Ahk2Exe.exe" -ArgumentList "/in","portable\unchanged.ahk","/out","dist\kolemak-unchanged.exe","/icon","assets\icon.ico","/base","$env:TEMP\ahk-v2\AutoHotkey64.exe" -Wait -NoNewWindow
        if (!(Test-Path dist\kolemak-unchanged.exe)) { throw "Compilation failed for unchanged.ahk" }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ahk-exe
        path: dist/*.exe

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        files: |
          dist/kolemak-changed.exe
          dist/kolemak-unchanged.exe
